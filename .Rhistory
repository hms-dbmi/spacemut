output='/d0/home/solrust/mutations/spacemut/vignettes/inference_processes.md')
q()
()
q()
setwd("")
setwd("..")
getwd()
load("topmed_final_11_12.RData")
nf <- layout(matrix( c(1,2,3,1,2,4) ,2,3, byrow=T), width=c(2,2,1),heights=c(1,1), respect=T)
#layout.show(nf)
# plot strand-independent process
mut.type <- "CGG_C"
mut.type.coml <- xcompl[rownames(icM)%in%mut.type]
cmp <- 10
#par(mar=c(6,6,3,0.5),mgp=c(2.5,1,0))
par(mar=c(6,6,3,3),mgp=c(2.5,1,0))
plot(icM[,cmp],icM[xcompl,cmp],cex=1,pch=19,main="strand-independent process",cex.main=1.7,font.main=2,
xlab=paste("spectrum, comp.",cmp),ylab=paste("reverse complement spectrum,\ncomp.",cmp),cex.lab=1.5,cex.axis=1.5)
segments(min(icM[,cmp])-1, icM[mut.type,cmp], icM[mut.type.coml,cmp], icM[mut.type,cmp],col = "darkgreen", lty = 2, lwd =1.5)
segments( icM[mut.type.coml,cmp],min(icM[,cmp])-1, icM[mut.type.coml,cmp],icM[mut.type,cmp],col = "darkorange", lty = 2, lwd =1.5)
segments(min(icM[,cmp])-1, icM[mut.type.coml,cmp], icM[mut.type,cmp], icM[mut.type.coml,cmp],col = "darkorange", lty = 2, lwd =1.5)
segments( icM[mut.type,cmp],min(icM[,cmp])-1, icM[mut.type,cmp],icM[mut.type.coml,cmp],col = "darkgreen", lty = 2, lwd =1.5)
#abline(h=0,lty=2);abline(v=0,lty=2)
legend("topleft",c("CGG > C","CCG > G"),fill=NA,border=NA,bty="n",col=c("darkgreen","darkorange"),pch=19,cex=1.5)
rh <- round(cor(icM[,cmp],icM[xcompl,cmp],method="spearman"),2)
legend("bottomright", legend=bquote(rho == .(rh)),fill=NA,border=NA,bty="n",cex=1.5)
# plot strand-dependent process
mut.type <- "GAC_G"
mut.type.coml <- xcompl[rownames(icM)%in%mut.type]
p1 <- 1; p2 <- 2
#par(mar=c(4.5,6,3,0.5),mgp=c(2.5,1,0))
par(mar=c(6,7,3,2),mgp=c(2.5,1,0))
plot(icM[,p1],icM[xcompl,p2],cex=1,pch=19,main="strand-dependent process",cex.main=1.7,font.main=2,
xlab="spectrum, comp. 1",ylab="reverse complement spectrum,\ncomp. 2",cex.lab=1.5,cex.axis=1.5)
segments(min(icM[,p1])-1, icM[mut.type.coml,p2], icM[mut.type,p1], icM[mut.type.coml,p2],col = "darkorange", lty = 2, lwd =1.5)
segments( icM[mut.type,p1],min(icM[,p2])-1, icM[mut.type,p1],icM[mut.type.coml,p2],col = "darkgreen", lty = 2, lwd =1.5)
segments(min(icM[,p1])-1, icM[mut.type,p2], icM[mut.type.coml,p1], icM[mut.type,p2],col = "darkgreen", lty = 2, lwd =1.5)
segments( icM[mut.type.coml,p1],min(icM[,p2])-1, icM[mut.type.coml,p1],icM[mut.type,p2],col = "darkorange", lty = 2, lwd =1.5)
#abline(h=0,lty=2);abline(v=0,lty=2)
legend("topleft",c("GAC > G","GTC > C"),fill=NA,border=NA,bty="n",col=c("darkgreen","darkorange"),pch=19,cex=1.5)
rh <- round(cor(icM[,p1],icM[xcompl,p2],method="spearman"),2)
legend("bottomright", legend=bquote(rho == .(rh)),fill=NA,border=NA,bty="n",cex=1.5)
p1 <- 1; p2 <- 1
#par(mar=c(4,4,0.5,0.5),mgp=c(2.5,1,0))
par(mar=c(4,4,2,0.5),mgp=c(2.5,1,0))
plot(icM[,p1],icM[xcompl,p2],cex=0.5,pch=19,col=adjustcolor("black",0.5),#main="strand-independent process",cex.main=1.5,font.main=1,
xlab="comp. 1",ylab="rev. comp. 1",cex.lab=1.5,cex.axis=1.5)
segments(min(icM[,p1])-1, icM[mut.type.coml,p2], icM[mut.type,p1], icM[mut.type.coml,p2],col = "darkorange", lty = 2, lwd =1.5)
segments( icM[mut.type,p1],min(icM[,p2])-1, icM[mut.type,p1],icM[mut.type.coml,p2],col = "darkgreen", lty = 2, lwd =1.5)
segments(min(icM[,p1])-1, icM[mut.type,p2], icM[mut.type.coml,p1], icM[mut.type,p2],col = "darkgreen", lty = 2, lwd =1.5)
segments( icM[mut.type.coml,p1],min(icM[,p2])-1, icM[mut.type.coml,p1],icM[mut.type,p2],col = "darkorange", lty = 2, lwd =1.5)
#abline(h=0,lty=2);abline(v=0,lty=2)
#legend("topright",c("GAC > G","GTC > C"),fill=NA,border=NA,bty="n",col=c("darkgreen","darkorange"),pch=19,cex=1.5)
rh <- round(cor(icM[,p1],icM[xcompl,p2],method="spearman"),2)
legend("topright", legend=bquote(rho == .(rh)),fill=NA,border=NA,bty="n",cex=1.25)
par(mar=c(4,4,2,0.5),mgp=c(2.5,1,0))
p1 <- 2; p2 <- 2
#par(mfrow=c(1,1),mar=c(6,6,3,1),mgp=c(3,1,0))
plot(icM[,p1],icM[xcompl,p2],cex=0.5,pch=19,col=adjustcolor("black",0.5),#main="strand-independent process",cex.main=1.5,font.main=1,
xlab="comp. 2",ylab="rev. comp. 2",cex.lab=1.5,cex.axis=1.5)
segments(min(icM[,p1])-1, icM[mut.type.coml,p2], icM[mut.type,p1], icM[mut.type.coml,p2],col = "darkorange", lty = 2, lwd =1.5)
segments( icM[mut.type,p1],min(icM[,p2])-1, icM[mut.type,p1],icM[mut.type.coml,p2],col = "darkgreen", lty = 2, lwd =1.5)
segments(min(icM[,p1])-1, icM[mut.type,p2], icM[mut.type.coml,p1], icM[mut.type,p2],col = "darkgreen", lty = 2, lwd =1.5)
segments( icM[mut.type.coml,p1],min(icM[,p2])-1, icM[mut.type.coml,p1],icM[mut.type,p2],col = "darkorange", lty = 2, lwd =1.5)
#abline(h=0,lty=2);abline(v=0,lty=2)
#legend("topright",c("GAC > G","GTC > C"),fill=NA,border=NA,bty="n",col=c("darkgreen","darkorange"),pch=19,cex=1.5)
rh <- round(cor(icM[,p1],icM[xcompl,p2],method="spearman"),2)
legend("topright", legend=bquote(rho == .(rh)),fill=NA,border=NA,bty="n",cex=1.25)
par(mfrow=c(1,1))
# plot reflection matrix
par(mar=c(7,8,2,2),mgp=c(4.5,1,0))
image( mat^1.0,axes=FALSE,names=TRUE,col=adjustcolor( colorRampPalette(c("grey95","grey90","grey85","darkred"))(n = 60) ,1),
xlab="spectrum",ylab="reverse compementary\nspectrum",cex.lab=2,main="Reflection matrix",font.main=1,cex.main=2)
box(lwd=2)
axis( 1,outer=FALSE, at= seq(0,1,length.out = nrow(mat)),labels = rownames(mat),las=2,
col.axis="black",cex.axis=1)
axis( 2,outer=FALSE, at= seq(0,1,length.out = nrow(mat)),labels = rownames(mat),las=1,
col.axis="black",cex.axis=1)
pdf( "/d0/home/solrust/mutations/draft/figures/FigS1/reflection_statistics_heatmap.pdf",height = 5,width = 6 )
par(mfrow=c(1,1))
# plot reflection matrix
par(mar=c(7,8,2,2),mgp=c(4.5,1,0))
image( mat^1.0,axes=FALSE,names=TRUE,col=adjustcolor( colorRampPalette(c("grey95","grey90","grey85","darkred"))(n = 60) ,1),
xlab="spectrum",ylab="reverse complementary\nspectrum",cex.lab=2,main="Reflection matrix",font.main=1,cex.main=2)
box(lwd=2)
axis( 1,outer=FALSE, at= seq(0,1,length.out = nrow(mat)),labels = rownames(mat),las=2,
col.axis="black",cex.axis=1)
axis( 2,outer=FALSE, at= seq(0,1,length.out = nrow(mat)),labels = rownames(mat),las=1,
col.axis="black",cex.axis=1)
dev.off()
par(mar=rep(4,4))
image( as.matrix( seq( min(abs(corr)),max(abs(corr)),length.out=60 ) )^1,axes=FALSE,names=TRUE,
col=adjustcolor( colorRampPalette(c("white","darkred"))(n = 60) ,1),xlab="Spearman",line=2,
cex.lab=2,font.main=1,cex.main=2)
axis( 1,outer=FALSE,tick=TRUE,lwd.ticks = 2, at= seq(0,1,length.out = 2),
labels = round( c(min(abs(corr)),max(abs(corr))), 1),las=1,
col.axis="black",cex.axis=2)#,xpd=TRUE, hadj=0,line=6)
box(lwd=2)
load("topmed_final_table_11_13.RData")
par(mar=rep(4,4))
image( as.matrix( seq( min(abs(corr)),max(abs(corr)),length.out=60 ) )^1,axes=FALSE,names=TRUE,
col=adjustcolor( colorRampPalette(c("white","darkred"))(n = 60) ,1),xlab="Spearman",line=2,
cex.lab=2,font.main=1,cex.main=2)
axis( 1,outer=FALSE,tick=TRUE,lwd.ticks = 2, at= seq(0,1,length.out = 2),
labels = round( c(min(abs(corr)),max(abs(corr))), 1),las=1,
col.axis="black",cex.axis=2)#,xpd=TRUE, hadj=0,line=6)
box(lwd=2)
par(mar=rep(4,4))
image( as.matrix( seq( min(abs(corr)),max(abs(corr)),length.out=60 ) )^1,axes=FALSE,names=TRUE,
col=adjustcolor( colorRampPalette(c("white","darkred"))(n = 60) ,1),xlab="Spearman",line=2,
cex.lab=2,font.main=1,cex.main=2)
axis( 1,outer=FALSE,tick=TRUE,lwd.ticks = 2, at= seq(0,1,length.out = 2),
labels = round( c(min(abs(corr)),max(abs(corr))), 1),las=1,
col.axis="black",cex.axis=2)#,xpd=TRUE, hadj=0,line=6)
box(lwd=2)
par(mar=rep(4,4))
image( as.matrix( seq( min(abs(corr)),max(abs(corr)),length.out=60 ) )^1,axes=FALSE,names=TRUE,
col=adjustcolor( colorRampPalette(c("white","darkred"))(n = 60) ,1),xlab="Spearman",line=2,
cex.lab=2,font.main=1,cex.main=2)
axis( 1,outer=FALSE,tick=TRUE,lwd.ticks = 2, at= seq(0,1,length.out = 2),
labels = round( c(min(abs(corr)),max(abs(corr))), 1),las=1,
col.axis="black",cex.axis=2)#,xpd=TRUE, hadj=0,line=6)
box(lwd=2)
nf <- layout(matrix( c(1,2,3) ,1,3, byrow=T), width=c(1.0,0.4,0.4),heights=c(1))#, respect=T)
#layout.show(nf)
par(mar=c(2,9,9,1),mgp=c(4.5,1,0),xaxs="i",yaxs="i")
image( t((corr)[rev(1:nrow(corr)),])^1,axes=FALSE,names=TRUE,col=adjustcolor( colorRampPalette(c("blue","grey90","darkred"))(n = 60) ,1),
cex.lab=1.5,font.main=1,cex.main=2)
box(lwd=2)
text( -0.0/ncol(corr) + seq(0,1,length.out = ncol(corr)), par("usr")[2]+0.05,
srt = 60, adj=0.1, xpd = TRUE,  labels = colnames(corr), cex=1.1)
axis( 2,outer=FALSE,tick=FALSE, at= seq(0,1,length.out = nrow(corr)),labels = rownames(corr)[rev(1:nrow(corr))],las=1,
col.axis="black",cex.axis=1.1,xpd=TRUE, hadj=0,line=7)
#marks <- c(0,2,3,4,6,7,8,10) c(0,2,3,4,5,7,8,10)
#for (mark in marks){abline(h= (1+2*marks)/(ncol(process)-1)/2,lty="dashed",lwd=0.1)}
par(mar=c(2,0,9,0.5),mgp=c(4.5,1,0),xaxs="i",yaxt="n")
barplot( rev(vs*100),width=1,space=0.0,cex.lab=1.5,cex.axis=1.5,horiz=TRUE,xlim=c(0,0.4*100),
xlab="",ylab="",font.main=1,cex.main=1.5,col = "grey")
#for (mark in marks){abline(h= (1+1*marks),lty="dashed",lwd=0.1)}
title("contribution, %",line=1,font.main=1,cex.main=1.3)
par(mar=c(2,2,8,0.2),mgp=c(4.5,1,0),xaxs="i",yaxt="n")
barplot( rev(hl/1e+3),width=1,space=0.0,cex.lab=1.5,cex.axis=1.5,horiz=TRUE,xlim=c(0,5e+2),
xlab="",ylab="",font.main=1,cex.main=1.5,col = "grey")
#for (mark in marks){abline(h= (1+1*marks),lty="dashed",lwd=0.1)}
title("scale, kb",line=1,font.main=1,cex.main=1.3)
par(mar=rep(4,4))
image( as.matrix( seq( min(abs(corr)),max(abs(corr)),length.out=60 ) )^1,axes=FALSE,names=TRUE,
col=adjustcolor( colorRampPalette(c("white","darkred"))(n = 60) ,1),xlab="Spearman",line=2,
cex.lab=2,font.main=1,cex.main=2)
axis( 1,outer=FALSE,tick=TRUE,lwd.ticks = 2, at= seq(0,1,length.out = 2),
labels = round( c(min(abs(corr)),max(abs(corr))), 1),las=1,
col.axis="black",cex.axis=2)#,xpd=TRUE, hadj=0,line=6)
box(lwd=2)
par(mar=rep(4,4))
image( as.matrix( seq( min((corr)),max(abs(corr)),length.out=60 ) )^1,axes=FALSE,names=TRUE,
col=adjustcolor( colorRampPalette(c("white","darkred"))(n = 60) ,1),xlab="Spearman",line=2,
cex.lab=2,font.main=1,cex.main=2)
axis( 1,outer=FALSE,tick=TRUE,lwd.ticks = 2, at= seq(0,1,length.out = 2),
labels = round( c(min(abs(corr)),max(abs(corr))), 1),las=1,
col.axis="black",cex.axis=2)#,xpd=TRUE, hadj=0,line=6)
box(lwd=2)
par(mar=rep(4,4))
image( as.matrix( seq( min((corr)),max((corr)),length.out=60 ) )^1,axes=FALSE,names=TRUE,
col=adjustcolor( colorRampPalette(c("white","darkred"))(n = 60) ,1),xlab="Spearman",line=2,
cex.lab=2,font.main=1,cex.main=2)
axis( 1,outer=FALSE,tick=TRUE,lwd.ticks = 2, at= seq(0,1,length.out = 2),
labels = round( c(min(abs(corr)),max(abs(corr))), 1),las=1,
col.axis="black",cex.axis=2)#,xpd=TRUE, hadj=0,line=6)
box(lwd=2)
par(mar=rep(4,4))
image( as.matrix( seq( min((corr)),max((corr)),length.out=60 ) )^1,axes=FALSE,names=TRUE,
col=adjustcolor( colorRampPalette(c("blue","white","darkred"))(n = 60) ,1),xlab="Spearman",line=2,
cex.lab=2,font.main=1,cex.main=2)
axis( 1,outer=FALSE,tick=TRUE,lwd.ticks = 2, at= seq(0,1,length.out = 2),
labels = round( c(min(abs(corr)),max(abs(corr))), 1),las=1,
col.axis="black",cex.axis=2)#,xpd=TRUE, hadj=0,line=6)
box(lwd=2)
par(mar=rep(4,4))
image( as.matrix( seq( min((corr)),max((corr)),length.out=60 ) )^1,axes=FALSE,names=TRUE,
col=adjustcolor( colorRampPalette(c("blue","white","darkred"))(n = 60) ,1),xlab="Spearman",line=2,
cex.lab=2,font.main=1,cex.main=2)
axis( 1,outer=FALSE,tick=TRUE,lwd.ticks = 2, at= seq(0,1,length.out = 2),
labels = round( c(min((corr)),max((corr))), 1),las=1,
col.axis="black",cex.axis=2)#,xpd=TRUE, hadj=0,line=6)
box(lwd=2)
axis( 1,outer=FALSE,tick=TRUE,lwd.ticks = 2, at= seq(0,1,length.out = 2),
labels = round( c(min((corr)),max((corr))), 1),las=1,
col.axis="black",cex.axis=2)#,xpd=TRUE, hadj=0,line=6)
par(mar=rep(4,4))
image( as.matrix( seq( min((corr)),max((corr)),length.out=60 ) )^1,axes=FALSE,names=TRUE,
col=adjustcolor( colorRampPalette(c("blue","white","darkred"))(n = 60) ,1),xlab="Spearman",line=2,
cex.lab=2,font.main=1,cex.main=2)
axis( 1,outer=FALSE,tick=TRUE,lwd.ticks = 2, at= seq(0,1,length.out = 2),
labels = round( c(min((corr)),max((corr))), 1),las=1,
col.axis="black",cex.axis=2)#,xpd=TRUE, hadj=0,line=6)
box(lwd=2)
pdf( "/d0/home/solrust/mutations/draft/figures/processes_table_colbar.pdf",height = 2,width = 4)
par(mar=rep(4,4))
image( as.matrix( seq( min((corr)),max((corr)),length.out=60 ) )^1,axes=FALSE,names=TRUE,
col=adjustcolor( colorRampPalette(c("blue","white","darkred"))(n = 60) ,1),xlab="Spearman",line=2,
cex.lab=2,font.main=1,cex.main=2)
axis( 1,outer=FALSE,tick=TRUE,lwd.ticks = 2, at= seq(0,1,length.out = 2),
labels = round( c(min((corr)),max((corr))), 1),las=1,
col.axis="black",cex.axis=2)#,xpd=TRUE, hadj=0,line=6)
box(lwd=2)
dev.off()
library(NMF)
install.packages("NMF")
library(NMF)
dim(rate)
inds <- sample(1:nrow(rate),100)
head(inds)
range(inds)
?nmf
inds <- sample(1:nrow(rate),100)
V <- rate[inds,]
nmf1 <- nmf(V,c(4,6))#,seed="ica",.opt = "vp30")
dim(V)
nmf1 <- nmf(V,c(4,6)),nrun=1,.opt = "vp30")
nmf1 <- nmf(V,c(4,6),nrun=1,.opt = "vp30")
res <- nmf1
V.hat <- fitted(res)
w <- basis(res)
h <- coef(res)
m <- apply(V,2,mean)
ssd <- apply(V,2,sd)
h1 <- t(apply(h,1,function(x) (x/sum(x)-m)/ssd  ))
dim(h)
dim(h[[1]])
str(res)
str(res[[1]])
res <- nmf1[[1]]
V.hat <- fitted(res)
w <- basis(res)
h <- coef(res)
m <- apply(V,2,mean)
ssd <- apply(V,2,sd)
h1 <- t(apply(h,1,function(x) (x/sum(x)-m)/ssd  ))
#h1 <- t(apply(h,1,function(x) (x/sum-m)/ssd  ))
str(res)
V.hat
length(nmf)
length(nmf1)
str(nmf1[[1]])
length(nmf1[[1]])
str(nmf1[[2]])
str(nmf1[[3]])
res <- nmf1#[[1]]
V.hat <- fitted(res)
str(V.hat)
nmf1 <- nmf(V,c(6),nrun=1,.opt = "vp30")
res <- nmf1#[[1]]
V.hat <- fitted(res)
str(nmf1)
w <- basis(res)
h <- coef(res)
m <- apply(V,2,mean)
ssd <- apply(V,2,sd)
h1 <- t(apply(h,1,function(x) (x/sum(x)-m)/ssd  ))
#h
mat = cor(t(h1[,]),t(h1[,xcompl]),method="spearman"); #mat[mat < 0] = 0
#mat = cor(t(h1[,]),icM[,],method="pearson"); #mat[mat < 0] = 0
#mat = cor((icM[,]),icM[,],method="pearson"); #mat[mat < 0] = 0
#mat = cor((w1[,]),method="pearson"); #mat[mat < 0] = 0
heatmap.2( mat^3,key=TRUE,Rowv=NA,Colv=NA,trace="none",col = colorRampPalette(c("blue","grey80",'red'))(40) )
apply(abs(mat),1,max)
sum( apply(abs(mat),1,max) > 0.8 )
library(gplots)
mat = cor(t(h1[,]),t(h1[,xcompl]),method="spearman"); #mat[mat < 0] = 0
#mat = cor(t(h1[,]),icM[,],method="pearson"); #mat[mat < 0] = 0
#mat = cor((icM[,]),icM[,],method="pearson"); #mat[mat < 0] = 0
#mat = cor((w1[,]),method="pearson"); #mat[mat < 0] = 0
heatmap.2( mat^3,key=TRUE,Rowv=NA,Colv=NA,trace="none",col = colorRampPalette(c("blue","grey80",'red'))(40) )
apply(abs(mat),1,max)
sum( apply(abs(mat),1,max) > 0.8 )
head(h)
dim(h)
spacemut::draw.signature(h[1,])
spacemut::draw.signature(h[1,])
spacemut::draw.signature(h[2,])
spacemut::draw.signature(h[5,])
spacemut::draw.signature(h[6,])
spacemut::draw.signature(h[5,])
spacemut::draw.signature(h[4,])
spacemut::draw.signature(h[3,])
spacemut::draw.signature(h[2,])
spacemut::draw.signature(h[1,])
dim(h)
spacemut::draw.signature(h1[1,])
spacemut::draw.signature(h1[1,])
spacemut::draw.signature(h[1,])
h1 <- t(apply(h,1,function(x) (x-m) ))
spacemut::draw.signature(h[1,])
spacemut::draw.signature(h1[1,])
spacemut::draw.signature(h1[2,])
spacemut::draw.signature(h1[3,])
spacemut::draw.signature(h1[4,])
spacemut::draw.signature(h1[5,])
spacemut::draw.signature(h1[6,])
m
spacemut::draw.signature(m)
spacemut::draw.signature(h[1,])
spacemut::draw.signature(h[2,])
spacemut::draw.signature(h[3,])
spacemut::draw.signature(h[4,])
spacemut::draw.signature(h[5,])
h1 <- t(apply(h,1,function(x) (x/sum(x)-m/sum(m)) ))
spacemut::draw.signature(h[4,])
spacemut::draw.signature(h1[4,])
spacemut::draw.signature(h1[1,])
spacemut::draw.signature(h1[2,])
spacemut::draw.signature(h1[3,])
spacemut::draw.signature(h1[4,])
spacemut::draw.signature(h1[5,])
spacemut::draw.signature(h1[6,])
mat = cor(t(h1[,]),t(h1[,xcompl]),method="spearman"); #mat[mat < 0] = 0
#mat = cor(t(h1[,]),icM[,],method="pearson"); #mat[mat < 0] = 0
#mat = cor((icM[,]),icM[,],method="pearson"); #mat[mat < 0] = 0
#mat = cor((w1[,]),method="pearson"); #mat[mat < 0] = 0
heatmap.2( mat^3,key=TRUE,Rowv=NA,Colv=NA,trace="none",col = colorRampPalette(c("blue","grey80",'red'))(40) )
apply(abs(mat),1,max)
sum( apply(abs(mat),1,max) > 0.8 )
mat = cor(t(h1[,]),t(h1[,xcompl]),method="spearman"); #mat[mat < 0] = 0
#mat = cor(t(h1[,]),icM[,],method="pearson"); #mat[mat < 0] = 0
#mat = cor((icM[,]),icM[,],method="pearson"); #mat[mat < 0] = 0
#mat = cor((w1[,]),method="pearson"); #mat[mat < 0] = 0
heatmap.2( mat^3,key=TRUE,Rowv=NA,Colv=NA,trace="none",col = colorRampPalette(c("blue","grey80",'red'))(40) )
apply(abs(mat),1,max)
sum( apply(abs(mat),1,max) > 0.7 )
nmf1 <- nmf(V,c(10),nrun=1,.opt = "vp30")
res <- nmf1#[[1]]
V.hat <- fitted(res)
w <- basis(res)
h <- coef(res)
m <- apply(V,2,mean)
ssd <- apply(V,2,sd)
h1 <- t(apply(h,1,function(x) (x/sum(x)-m/sum(m)) ))
#h1 <- t(apply(h,1,function(x) (x/sum-m)/ssd  ))
w1 <- t(t(w)*apply(h,1,function(x) sum(x)  ))
mat = cor(t(h1[,]),t(h1[,xcompl]),method="spearman"); #mat[mat < 0] = 0
#mat = cor(t(h1[,]),icM[,],method="pearson"); #mat[mat < 0] = 0
#mat = cor((icM[,]),icM[,],method="pearson"); #mat[mat < 0] = 0
#mat = cor((w1[,]),method="pearson"); #mat[mat < 0] = 0
heatmap.2( mat^3,key=TRUE,Rowv=NA,Colv=NA,trace="none",col = colorRampPalette(c("blue","grey80",'red'))(40) )
apply(abs(mat),1,max)
sum( apply(abs(mat),1,max) > 0.7 )
mat = cor(t(h1[,]),t(h1[,xcompl]),method="spearman"); #mat[mat < 0] = 0
#mat = cor(t(h1[,]),icM[,],method="pearson"); #mat[mat < 0] = 0
#mat = cor((icM[,]),icM[,],method="pearson"); #mat[mat < 0] = 0
#mat = cor((w1[,]),method="pearson"); #mat[mat < 0] = 0
heatmap.2( mat^3,key=TRUE,Rowv=NA,Colv=NA,trace="none",col = colorRampPalette(c("blue","grey80",'red'))(40) )
apply(abs(mat),1,max)
sum( apply(abs(mat),1,max) > 0.7 )
spacemut::draw.signature(h1[1,])
spacemut::draw.signature(h1[1,])
spacemut::draw.signature(h1[2,])
spacemut::draw.signature(h1[3,])
spacemut::draw.signature(h1[4,])
spacemut::draw.signature(h1[5,])
inds <- sample(1:nrow(rate),1000)
V <- rate[inds,]
#V <- t(t(V)/apply(V,2,mean))
#V <- t(apply(V,1,function(x) x/sum(x) ))
nmf1 <- nmf(V,c(10),nrun=1,.opt = "vp30")
#saveRDS(nmf.ica,"/d0/home/solrust/mutations/topmed/nmf_ica.rds")
res <- nmf1#[[1]]
V.hat <- fitted(res)
w <- basis(res)
h <- coef(res)
m <- apply(V,2,mean)
ssd <- apply(V,2,sd)
h1 <- t(apply(h,1,function(x) (x/sum(x)-m/sum(m)) ))
#h1 <- t(apply(h,1,function(x) (x/sum-m)/ssd  ))
mat = cor(t(h1[,]),t(h1[,xcompl]),method="spearman"); #mat[mat < 0] = 0
#mat = cor(t(h1[,]),icM[,],method="pearson"); #mat[mat < 0] = 0
#mat = cor((icM[,]),icM[,],method="pearson"); #mat[mat < 0] = 0
#mat = cor((w1[,]),method="pearson"); #mat[mat < 0] = 0
heatmap.2( mat^3,key=TRUE,Rowv=NA,Colv=NA,trace="none",col = colorRampPalette(c("blue","grey80",'red'))(40) )
apply(abs(mat),1,max)
sum( apply(abs(mat),1,max) > 0.7 )
spacemut::draw.signature(h1[5,])
spacemut::draw.signature(h1[4,])
spacemut::draw.signature(h1[4,])
spacemut::draw.signature(h1[1,])
spacemut::draw.signature(h1[2,])
spacemut::draw.signature(h1[3,])
spacemut::draw.signature(h1[4,])
spacemut::draw.signature(h1[5,])
spacemut::draw.signature(h1[6,])
spacemut::draw.signature(h1[7,])
spacemut::draw.signature(h1[8,])
spacemut::draw.signature(h1[9,])
h1 <- t(apply(h,1,function(x) (x/sum(x)-m/sum(m))/ssd ))
mat = cor(t(h1[,]),t(h1[,xcompl]),method="spearman"); #mat[mat < 0] = 0
#mat = cor(t(h1[,]),icM[,],method="pearson"); #mat[mat < 0] = 0
#mat = cor((icM[,]),icM[,],method="pearson"); #mat[mat < 0] = 0
#mat = cor((w1[,]),method="pearson"); #mat[mat < 0] = 0
heatmap.2( mat^3,key=TRUE,Rowv=NA,Colv=NA,trace="none",col = colorRampPalette(c("blue","grey80",'red'))(40) )
apply(abs(mat),1,max)
sum( apply(abs(mat),1,max) > 0.7 )
spacemut::draw.signature(h1[1,])
spacemut::draw.signature(h1[1,])
spacemut::draw.signature(h1[2,])
spacemut::draw.signature(h1[3,])
spacemut::draw.signature(h1[4,])
spacemut::draw.signature(h1[5,])
spacemut::draw.signature(h1[6,])
spacemut::draw.signature(h1[7,])
spacemut::draw.signature(h1[8,])
spacemut::draw.signature(h1[9,])
spacemut::draw.signature(h1[10,])
nmf1 <- nmf(V,c(10),nrun=1)#,.opt = "vp30")
?nmf
nmf1 <- nmf(V,c(10),nrun=2)#,.opt = "vp30")
inds <- sample(1:nrow(rate),10000)
V <- rate[inds,]
nmf1 <- nmf(V,c(10),nrun=1,.opt = "vp30")
res <- nmf1#[[1]]
V.hat <- fitted(res)
w <- basis(res)
h <- coef(res)
m <- apply(V,2,mean)
ssd <- apply(V,2,sd)
h1 <- t(apply(h,1,function(x) (x/sum(x)-m/sum(m))/ssd ))
#h1 <- t(apply(h,1,function(x) (x/sum-m)/ssd  ))
w1 <- t(t(w)*apply(h,1,function(x) sum(x)  ))
mat = cor(t(h1[,]),t(h1[,xcompl]),method="spearman"); #mat[mat < 0] = 0
#mat = cor(t(h1[,]),icM[,],method="pearson"); #mat[mat < 0] = 0
#mat = cor((icM[,]),icM[,],method="pearson"); #mat[mat < 0] = 0
#mat = cor((w1[,]),method="pearson"); #mat[mat < 0] = 0
heatmap.2( mat^3,key=TRUE,Rowv=NA,Colv=NA,trace="none",col = colorRampPalette(c("blue","grey80",'red'))(40) )
apply(abs(mat),1,max)
sum( apply(abs(mat),1,max) > 0.7 )
spacemut::draw.signature(h1[1,])
spacemut::draw.signature(h1[1,])
spacemut::draw.signature(h1[2,])
spacemut::draw.signature(h1[3,])
spacemut::draw.signature(h1[4,])
spacemut::draw.signature(h1[5,])
spacemut::draw.signature(h1[6,])
spacemut::draw.signature(h1[7,])
spacemut::draw.signature(h1[8,])
spacemut::draw.signature(h1[9,])
heatmap.2( mat^3,key=TRUE,Rowv=NA,Colv=NA,trace="none",col = colorRampPalette(c("blue","grey80",'red'))(40) )
mat
comp.info1 <- extract.comp(rate.new,10)
icM1 <- comp.info1[[1]]
icS1 <- comp.info1[[2]]
mat = (cor(icM1,icM1[xcompl,],method="spearman")); #mat[mat < 0] = 0
heatmap.2( mat^3,key=TRUE,Rowv=NA,Colv=NA,trace="none",col = colorRampPalette(c("blue","grey80",'red'))(10),main="ICA-spectra" )
sum( abs(mat) > 0.7 )
heatmap.2( mat^3,key=TRUE,Rowv=NA,Colv=NA,trace="none",col = colorRampPalette(c("blue","grey80",'red'))(10),main="ICA-spectra" )
sum( abs(mat) > 0.7 )
sum( abs(mat) > 0.8 )
sum( abs(mat) > 0.7 )
sum( abs(mat) > 0.8 )
sum( abs(mat) > 0.7 )
mat = cor(t(h1[,]),t(h1[,xcompl]),method="spearman"); #mat[mat < 0] = 0
#mat = cor(t(h1[,]),icM[,],method="pearson"); #mat[mat < 0] = 0
#mat = cor((icM[,]),icM[,],method="pearson"); #mat[mat < 0] = 0
#mat = cor((w1[,]),method="pearson"); #mat[mat < 0] = 0
heatmap.2( mat^3,key=TRUE,Rowv=NA,Colv=NA,trace="none",col = colorRampPalette(c("blue","grey80",'red'))(40) )
apply(abs(mat),1,max)
heatmap.2( mat^3,key=TRUE,Rowv=NA,Colv=NA,trace="none",col = colorRampPalette(c("blue","grey80",'red'))(40) )
sum( abs(mat) > 0.7 )
sum( apply(abs(mat),1,max) > 0.7 )
mat = (cor(icM1,icM1[xcompl,],method="spearman")); #mat[mat < 0] = 0
heatmap.2( mat^3,key=TRUE,Rowv=NA,Colv=NA,trace="none",col = colorRampPalette(c("blue","grey80",'red'))(10),main="ICA-spectra" )
sum( abs(mat) > 0.7 )
sum( apply(abs(mat),1,max) > 0.7 )
sum( abs(mat) > 0.8 )
sum( apply(abs(mat),1,max) > 0.8 )
mat = cor(t(h1[,]),t(h1[,xcompl]),method="spearman"); #mat[mat < 0] = 0
#mat = cor(t(h1[,]),icM[,],method="pearson"); #mat[mat < 0] = 0
#mat = cor((icM[,]),icM[,],method="pearson"); #mat[mat < 0] = 0
#mat = cor((w1[,]),method="pearson"); #mat[mat < 0] = 0
heatmap.2( mat^3,key=TRUE,Rowv=NA,Colv=NA,trace="none",col = colorRampPalette(c("blue","grey80",'red'))(40) )
apply(abs(mat),1,max)
sum( apply(abs(mat),1,max) > 0.8 )
sum( apply(abs(mat),1,max) > 0.7 )
inds <-1:nrow(rate)
V <- rate[inds,]
#V <- t(t(V)/apply(V,2,mean))
#V <- t(apply(V,1,function(x) x/sum(x) ))
nmf1 <- nmf(V,c(8),nrun=1,.opt = "vp30")
#saveRDS(nmf.ica,"/d0/home/solrust/mutations/topmed/nmf_ica.rds")
mat = (cor(icM,icM[xcompl,],method="spearman")); #mat[mat < 0] = 0
mat
spacemut::draw.signature(icM[,1])
spacemut::draw.signature(icM[,2])
spacemut::draw.signature(icM[,3])
spacemut::draw.signature(icM[,4])
res <- nmf1#[[1]]
V.hat <- fitted(res)
w <- basis(res)
h <- coef(res)
m <- apply(V,2,mean)
ssd <- apply(V,2,sd)
h1 <- t(apply(h,1,function(x) (x/sum(x)-m/sum(m))/ssd ))
#h1 <- t(apply(h,1,function(x) (x/sum-m)/ssd  ))
w1 <- t(t(w)*apply(h,1,function(x) sum(x)  ))
mat = cor(t(h1[,]),t(h1[,xcompl]),method="spearman"); #mat[mat < 0] = 0
#mat = cor(t(h1[,]),icM[,],method="pearson"); #mat[mat < 0] = 0
#mat = cor((icM[,]),icM[,],method="pearson"); #mat[mat < 0] = 0
#mat = cor((w1[,]),method="pearson"); #mat[mat < 0] = 0
heatmap.2( mat^3,key=TRUE,Rowv=NA,Colv=NA,trace="none",col = colorRampPalette(c("blue","grey80",'red'))(40) )
apply(abs(mat),1,max)
sum( apply(abs(mat),1,max) > 0.8 )
sum( apply(abs(mat),1,max) > 0.7 )
lengt(inds)
length(inds)
q()
